files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/run_worker.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env bash
      
      # Get the environment variables
      source /opt/elasticbeanstalk/deployment/env

      # Create log directory
      sudo mkdir -p /var/log/celery
      sudo chmod 777 /var/log/celery

      # Kill existing worker
      sudo pkill -f "celery worker" || true

      # Start celery worker
      cd /var/app/current
      source /var/app/venv/*/bin/activate
      celery -A celery_worker.celery_app worker --loglevel=info \
        --logfile=/var/log/celery/worker.log \
        --detach 